{% extends "layout.html" %}

{% block page_title %}Product Management{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header Actions -->
    <div class="flex justify-between items-center">
        <div class="relative w-96">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
            <input type="text" placeholder="Search products..."
                class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="flex gap-2">
            <form action="{{ url_for('inventory.sync_daraz') }}" method="POST">
                <button type="submit"
                    class="bg-orange-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-orange-700 flex items-center shadow-sm transition-all">
                    <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                    Sync via API
                </button>
            </form>
            <button onclick="document.getElementById('import-daraz-modal').classList.remove('hidden')"
                class="bg-orange-100 text-orange-700 px-4 py-2 rounded-lg font-medium hover:bg-orange-200 flex items-center shadow-sm transition-all border border-orange-200">
                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                Import File
            </button>
            <button onclick="document.getElementById('add-product-modal').classList.remove('hidden')"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 flex items-center shadow-sm transition-all">
                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                Add New Product
            </button>
        </div>
    </div>

    <!-- Product Table -->
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-slate-50 border-b border-slate-200">
                <tr>
                    <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase">Product Info</th>
                    <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase">Category</th>
                    <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase">Cost / Selling</th>
                    <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase">Stock</th>
                    <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-200">
                {% for product in products %}
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-medium text-slate-900">{{ product.name }}</div>
                        <div class="text-xs text-slate-400">SKU: {{ product.sku or 'N/A' }}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs">{{ product.category.name if
                            product.category else 'Uncategorized' }}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-slate-600">C: {{ "%.2f"|format(product.cost_price) }}</div>
                        <div class="text-sm font-bold text-blue-600">S: {{ "%.2f"|format(product.selling_price) }}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <span
                                class="text-sm font-semibold {% if product.stock_qty <= product.low_stock_threshold %}text-red-500{% else %}text-slate-900{% endif %}">
                                {{ product.stock_qty }} Units
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button class="text-slate-400 hover:text-blue-600 mx-2"><i data-lucide="edit-2"
                                class="w-4 h-4"></i></button>
                        <button
                            onclick="openStockInModal('{{ product.id }}', '{{ product.name }}', '{{ product.cost_price }}')"
                            class="text-slate-400 hover:text-green-600 mx-2" title="Manual Stock In">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="px-6 py-12 text-center text-slate-400 italic">No products found. Add your
                        first product to get started.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Simple Add Modal -->
<div id="add-product-modal"
    class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-xl w-full max-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
            <h3 class="font-bold text-slate-800">Add New Product</h3>
            <button onclick="document.getElementById('add-product-modal').classList.add('hidden')"
                class="text-slate-400 hover:text-slate-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <form action="{{ url_for('inventory.add_product') }}" method="POST" class="p-6 space-y-4 text-sm">
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block font-semibold text-slate-700 mb-1">Product Name *</label>
                    <input type="text" name="name" required
                        class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block font-semibold text-slate-700 mb-1">SKU / Code</label>
                    <input type="text" name="sku"
                        class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block font-semibold text-slate-700 mb-1">Category</label>
                    <select name="category_id"
                        class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Category</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block font-semibold text-slate-700 mb-1">Cost Price (LKR) *</label>
                    <input type="number" step="0.01" name="cost_price" required
                        class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block font-semibold text-slate-700 mb-1">Selling Price (LKR) *</label>
                    <input type="number" step="0.01" name="selling_price" required
                        class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block font-semibold text-slate-700 mb-1">Initial Stock</label>
                    <input type="number" name="stock_qty" value="0"
                        class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block font-semibold text-slate-700 mb-1">Low Stock Alert</label>
                    <input type="number" name="low_stock_threshold" value="5"
                        class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="pt-4 flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('add-product-modal').classList.add('hidden')"
                    class="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg">Cancel</button>
                <button type="submit"
                    class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md transition-all">Save
                    Product</button>
            </div>
        </form>
    </div>
</div>

<!-- Stock In Modal -->
<div id="stock-in-modal"
    class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-green-50">
            <h3 class="font-bold text-slate-800">Stock Update: <span id="stock-product-name"></span></h3>
            <button onclick="document.getElementById('stock-in-modal').classList.add('hidden')"
                class="text-slate-400 hover:text-slate-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <form id="stock-in-form" method="POST" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">Quantity to Add *</label>
                <input type="number" name="adjustment" required placeholder="Enter positive number"
                    class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">New Cost Price (Optional)</label>
                <input type="number" step="0.01" name="cost_price" id="stock-product-cost"
                    class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">Supplier</label>
                <select name="supplier_id"
                    class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-green-500">
                    <option value="">N/A</option>
                    {% for sup in suppliers %}
                    <option value="{{ sup.id }}">{{ sup.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="pt-4 flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('stock-in-modal').classList.add('hidden')"
                    class="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg">Cancel</button>
                <button type="submit"
                    class="px-6 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 shadow-md">Record
                    Purchase</button>
            </div>
        </form>
    </div>
</div>


<!-- Daraz Import Modal -->
<div id="import-daraz-modal"
    class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-orange-50">
            <h3 class="font-bold text-slate-800">Import from Daraz Seller Center</h3>
            <button onclick="document.getElementById('import-daraz-modal').classList.add('hidden')"
                class="text-slate-400 hover:text-slate-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <form action="{{ url_for('inventory.import_daraz') }}" method="POST" enctype="multipart/form-data"
            class="p-6 space-y-4">
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-xs text-orange-800 mb-4">
                <p class="font-bold mb-1">Instructions:</p>
                <ul class="list-disc list-inside space-y-1">
                    <li>Upload the CSV or Excel file exported from Daraz Seller Center.</li>
                    <li>Ensure column headers like <b>Seller SKU</b>, <b>Name</b>, <b>Price</b>, and <b>Quantity</b> are
                        present.</li>
                    <li>Existing SKUs will be updated; new SKUs will be added.</li>
                </ul>
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">Select File (CSV, XLSX) *</label>
                <input type="file" name="file" required accept=".csv, .xlsx, .xls"
                    class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-orange-500">
            </div>
            <div class="pt-4 flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('import-daraz-modal').classList.add('hidden')"
                    class="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg">Cancel</button>
                <button type="submit"
                    class="px-6 py-2 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 shadow-md">Start
                    Import</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openStockInModal(id, name, cost) {
        document.getElementById('stock-product-name').textContent = name;
        document.getElementById('stock-product-cost').value = cost;
        document.getElementById('stock-in-form').action = '/inventory/update_stock/' + id;
        document.getElementById('stock-in-modal').classList.remove('hidden');
    }
</script>
{% endblock %}